<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BrainBuzz - Das ultimative Quiz-Duell</title>
    <script src="/socket.io/socket.io.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;700;800;900&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Space Grotesk', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #1e293b 0%, #581c87 50%, #1e293b 100%);
            min-height: 100vh;
            color: white;
            overflow-x: hidden;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .screen {
            display: none;
            opacity: 0;
        }

        .screen.active {
            display: block;
            animation: fadeIn 0.4s ease-in;
            opacity: 1;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card {
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(20px);
            border-radius: 1.5rem;
            padding: 2rem;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(168, 85, 247, 0.2);
        }

        .title {
            text-align: center;
            font-size: 4rem;
            font-weight: 900;
            margin-bottom: 1rem;
            letter-spacing: -2px;
        }

        .subtitle {
            text-align: center;
            color: #c084fc;
            font-size: 1.25rem;
            margin-bottom: 2rem;
        }

        input, select, textarea {
            width: 100%;
            padding: 1rem;
            background: rgba(15, 23, 42, 0.5);
            border: 2px solid #334155;
            border-radius: 0.75rem;
            color: white;
            font-size: 1rem;
            transition: border-color 0.3s;
            margin-bottom: 1rem;
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #a855f7;
        }

        input::placeholder, textarea::placeholder {
            color: #64748b;
        }

        button {
            padding: 1rem 1.5rem;
            border: none;
            border-radius: 0.75rem;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            margin-top: 0.5rem;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: linear-gradient(135deg, #9333ea 0%, #db2777 100%);
            color: white;
            box-shadow: 0 10px 30px rgba(147, 51, 234, 0.5);
        }

        .btn-primary:hover:not(:disabled) {
            transform: scale(1.02);
            box-shadow: 0 15px 40px rgba(147, 51, 234, 0.6);
        }

        .btn-secondary {
            background: #475569;
            color: white;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #334155;
        }

        .btn-success {
            background: linear-gradient(135deg, #059669 0%, #10b981 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc2626 0%, #f97316 100%);
            color: white;
        }

        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
            width: auto;
        }

        .btn-warning {
            background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);
            color: white;
        }

        .setting-group {
            margin: 1rem 0;
            padding: 1rem;
            background: rgba(15, 23, 42, 0.5);
            border-radius: 0.75rem;
            border: 2px solid #334155;
        }

        .setting-group label {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: white;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .setting-group input[type="checkbox"] {
            width: auto;
            margin: 0;
        }

        .setting-group input[type="number"], .setting-group select {
            width: auto;
            min-width: 100px;
        }

        .player-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            margin: 1.5rem 0;
        }

        .player-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: rgba(15, 23, 42, 0.5);
            border-radius: 0.75rem;
            border: 2px solid #334155;
        }

        .player-item.host {
            background: rgba(168, 85, 247, 0.2);
            border-color: #a855f7;
        }

        .custom-questions-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            margin: 1rem 0;
        }

        .custom-question-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: rgba(168, 85, 247, 0.1);
            border-radius: 0.75rem;
            border: 2px solid #9333ea;
            gap: 1rem;
        }

        .custom-question-info {
            flex: 1;
        }

        .custom-question-meta {
            display: flex;
            gap: 1rem;
            font-size: 0.9rem;
            color: #c084fc;
            margin-top: 0.5rem;
        }

        .team-sidebar {
            position: fixed;
            top: 0;
            width: 250px;
            height: 100vh;
            background: rgba(30, 41, 59, 0.95);
            backdrop-filter: blur(20px);
            padding: 2rem 1rem;
            border: 1px solid rgba(168, 85, 247, 0.2);
        }

        .team-sidebar.left {
            left: 0;
            border-right: 2px solid #9333ea;
        }

        .team-sidebar.right {
            right: 0;
            border-left: 2px solid #db2777;
        }

        .team-header {
            font-size: 1.5rem;
            font-weight: 900;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid rgba(168, 85, 247, 0.3);
        }

        .team-score {
            font-size: 3rem;
            font-weight: 900;
            text-align: center;
            margin: 1rem 0;
            color: #c084fc;
        }

        .team-players {
            margin-top: 1rem;
        }

        .team-player {
            padding: 0.5rem;
            margin: 0.5rem 0;
            background: rgba(15, 23, 42, 0.5);
            border-radius: 0.5rem;
            font-size: 0.9rem;
        }

        .game-content {
            margin-left: 0;
            margin-right: 0;
            transition: margin 0.3s;
        }

        .game-content.with-teams {
            margin-left: 270px;
            margin-right: 270px;
        }

        .game-board {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin: 2rem 0;
        }

        .category-header {
            background: rgba(15, 23, 42, 0.5);
            padding: 1rem;
            text-align: center;
            border-radius: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            font-size: 0.9rem;
            border: 2px solid #334155;
        }

        .category-header.custom-cat {
            background: rgba(168, 85, 247, 0.2);
            border-color: #a855f7;
        }

        .question-cell {
            background: linear-gradient(135deg, #9333ea 0%, #db2777 100%);
            padding: 2rem;
            text-align: center;
            border-radius: 0.75rem;
            font-size: 2rem;
            font-weight: 900;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 10px 30px rgba(147, 51, 234, 0.5);
            position: relative;
        }

        .question-cell.custom-q {
            background: linear-gradient(135deg, #a855f7 0%, #ec4899 100%);
        }

        .question-cell.custom-q::after {
            content: '‚≠ê';
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            font-size: 1rem;
        }

        .question-cell:hover:not(.completed) {
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 15px 40px rgba(147, 51, 234, 0.7);
        }

        .question-cell.completed {
            background: rgba(75, 85, 99, 0.5);
            color: #9ca3af;
            cursor: not-allowed;
            box-shadow: none;
        }

        .scoreboard {
            background: rgba(15, 23, 42, 0.5);
            padding: 1.5rem;
            border-radius: 0.75rem;
            margin-bottom: 2rem;
            border: 2px solid #334155;
        }

        .score-item {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem;
            margin: 0.5rem 0;
            background: rgba(15, 23, 42, 0.5);
            border-radius: 0.5rem;
            border-left: 3px solid #9333ea;
        }

        .score-item.leader {
            border-left-color: #fbbf24;
            background: rgba(251, 191, 36, 0.1);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: rgba(30, 41, 59, 0.95);
            backdrop-filter: blur(20px);
            padding: 2rem;
            border-radius: 1.5rem;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(168, 85, 247, 0.3);
            max-width: 700px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .buzz-btn {
            font-size: 2em;
            padding: 2rem;
            background: linear-gradient(135deg, #dc2626 0%, #f97316 100%);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .room-code {
            font-size: 3rem;
            font-weight: 900;
            letter-spacing: 0.5rem;
            text-align: center;
            color: #c084fc;
            margin: 1rem 0;
            font-family: 'Courier New', monospace;
        }

        .host-controls {
            background: rgba(168, 85, 247, 0.1);
            border: 2px solid #a855f7;
            padding: 1.5rem;
            border-radius: 0.75rem;
            margin-top: 1rem;
        }

        .host-badge {
            display: inline-block;
            background: linear-gradient(135deg, #9333ea 0%, #db2777 100%);
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 700;
            font-size: 0.9rem;
        }

        .question-timer {
            font-size: 4rem;
            font-weight: 900;
            text-align: center;
            margin: 2rem 0;
            color: #10b981;
            animation: timerPulse 1s infinite;
        }

        .question-timer.warning {
            color: #f59e0b;
        }

        .question-timer.danger {
            color: #ef4444;
            animation: timerDanger 0.5s infinite;
        }

        @keyframes timerPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes timerDanger {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.15); color: #dc2626; }
        }

        .timer {
            font-size: 2rem;
            font-weight: 900;
            color: #fbbf24;
            text-align: center;
            margin: 1rem 0;
        }

        .buzzer-warning {
            background: rgba(220, 38, 38, 0.2);
            border: 2px solid #dc2626;
            padding: 1rem;
            border-radius: 0.75rem;
            margin: 1rem 0;
            text-align: center;
            animation: pulse 1s infinite;
        }

        .type-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 0.5rem;
            font-size: 0.8rem;
            font-weight: 700;
        }

        .type-text { background: #3b82f6; color: white; }
        .type-math { background: #f59e0b; color: white; }
        .type-error { background: #ef4444; color: white; }

        .bonus-section {
            background: rgba(251, 191, 36, 0.1);
            border: 2px solid #fbbf24;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin: 1rem 0;
        }

        .bonus-section h3 {
            color: #fbbf24;
            margin-bottom: 1rem;
        }

        .error-hint {
            background: rgba(239, 68, 68, 0.1);
            border: 2px solid #ef4444;
            border-radius: 0.75rem;
            padding: 1rem;
            margin: 1rem 0;
        }

        @media (max-width: 1200px) {
            .team-sidebar { display: none; }
            .game-content.with-teams {
                margin-left: 0;
                margin-right: 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Welcome Screen -->
        <div id="welcomeScreen" class="screen active">
            <div class="card">
                <h1 class="title">üß† BrainBuzz</h1>
                <p class="subtitle">Das ultimative Quiz-Duell!</p>
                <p style="text-align:center; color:#c084fc; margin-bottom:1rem;">5 zuf√§llige Kategorien pro Spiel!</p>
                <input type="text" id="playerNameInput" placeholder="Dein Name">
                <button class="btn-primary" onclick="createGame()">Als Host starten</button>
                <button class="btn-secondary" onclick="showJoinModal()">Als Spieler beitreten</button>
            </div>
        </div>

        <!-- Lobby Screen -->
        <div id="lobbyScreen" class="screen">
            <div class="card">
                <h1 class="title">üß† Lobby</h1>
                <div class="room-code" id="roomCode">ABC123</div>
                <p style="text-align:center; color:#c084fc; margin-bottom:2rem;">Teile diesen Code mit deinen Spielern!</p>
                
                <!-- Host Settings -->
                <div id="hostSettings" style="display:none;">
                    <h3 style="color:white; margin:2rem 0 1rem;">‚öôÔ∏è Einstellungen</h3>
                    
                    <div class="setting-group">
                        <label>
                            <input type="checkbox" id="teamModeToggle" onchange="toggleTeamMode()">
                            Team-Modus aktivieren
                        </label>
                    </div>

                    <div class="setting-group" id="teamSettings" style="display:none;">
                        <label>
                            Anzahl Teams:
                            <select id="numberOfTeams" onchange="updateSettings()">
                                <option value="2">2 Teams</option>
                                <option value="3">3 Teams</option>
                                <option value="4">4 Teams</option>
                            </select>
                        </label>
                    </div>

                    <div class="setting-group">
                        <label>
                            Frage-Zeit:
                            <input type="number" id="questionTime" value="30" min="10" max="120" onchange="updateSettings()">
                            Sekunden
                        </label>
                    </div>

                    <div class="setting-group">
                        <label>
                            Max. Custom-Fragen:
                            <select id="customQuestionsLimit" onchange="updateSettings()">
                                <option value="5">5 Fragen</option>
                                <option value="7">7 Fragen</option>
                                <option value="10">10 Fragen</option>
                            </select>
                        </label>
                    </div>

                    <div class="setting-group">
                        <label>
                            Custom-Fragen Bonus-Punkte:
                            <input type="number" id="customBonusPoints" value="50" min="10" max="200" step="10" onchange="updateSettings()">
                            Punkte
                        </label>
                        <p style="color:#c084fc; font-size:0.85rem; margin-top:0.5rem;">üí° <strong>Wichtig:</strong> Custom-Kategorie gibt NUR diese Bonus-Punkte!</p>
                    </div>

                    <!-- Custom Fragen -->
                    <h3 style="color:white; margin:2rem 0 1rem;">üìù Custom Fragen (<span id="customQuestionsCount">0</span>/<span id="customQuestionsMax">5</span>)</h3>
                    <button class="btn-primary" onclick="showAddCustomQuestionModal()">+ Custom Frage hinzuf√ºgen</button>
                    
                    <div class="custom-questions-list" id="customQuestionsList"></div>
                </div>
                
                <h3 style="color:white; margin:2rem 0 1rem;">Spieler (<span id="playerCount">0</span>)</h3>
                <div class="player-list" id="playerList"></div>
                
                <button class="btn-primary" id="startBtn" onclick="startGame()" style="display:none;">Spiel starten</button>
            </div>
        </div>

        <!-- Game Screen -->
        <div id="gameScreen" class="screen">
            <div id="teamSidebars"></div>

            <div class="game-content" id="gameContent">
                <div class="card">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem; flex-wrap:wrap; gap:1rem;">
                        <h1 class="title" style="margin:0; font-size:2.5rem;">üß† BrainBuzz</h1>
                        <div style="display:flex; gap:1rem; align-items:center;">
                            <button id="soundToggle" onclick="toggleSound()" style="width:auto; padding:0.75rem 1.5rem; background:rgba(15,23,42,0.5); border:2px solid #334155; cursor:pointer; font-size:1.5rem; margin:0;">üîä</button>
                            <div id="hostBadge" class="host-badge" style="display:none;">üéôÔ∏è HOST</div>
                            <div id="currentTurnDisplay" style="background:linear-gradient(135deg,#9333ea,#db2777); padding:0.75rem 1.5rem; border-radius:0.75rem; font-weight:700;"></div>
                        </div>
                    </div>

                    <div class="scoreboard" id="singleScoreboard" style="display:none;">
                        <h3 style="color:white; margin-bottom:1rem;">Punkte</h3>
                        <div id="scoresList"></div>
                    </div>

                    <div class="game-board" id="gameBoard"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Join Modal -->
    <div id="joinModal" class="modal">
        <div class="modal-content">
            <h2 style="color:white; text-align:center; margin-bottom:1.5rem;">Spiel beitreten</h2>
            <input type="text" id="joinRoomCode" placeholder="Raumcode (6 Zeichen)" maxlength="6">
            <input type="text" id="joinPlayerName" placeholder="Dein Name">
            <button class="btn-primary" onclick="joinGame()">Beitreten</button>
            <button class="btn-secondary" onclick="closeJoinModal()">Abbrechen</button>
        </div>
    </div>

    <!-- Add Custom Question Modal -->
    <div id="addCustomQuestionModal" class="modal">
        <div class="modal-content">
            <h2 style="color:white; text-align:center; margin-bottom:1.5rem;">Custom Frage hinzuf√ºgen</h2>
            
            <label style="color:white; font-weight:700; margin-bottom:0.5rem; display:block;">Kategorie:</label>
            <select id="customCategory">
                <option value="allgemeinwissen">Allgemeinwissen</option>
                <option value="wissenschaft">Wissenschaft</option>
                <option value="geschichte">Geschichte</option>
                <option value="sport">Sport</option>
                <option value="geographie">Geographie</option>
                <option value="mathe">Mathe</option>
                <option value="fehlersuche">Fehlersuche</option>
                <option value="custom">‚ú® Custom (NUR Bonus-Punkte!)</option>
            </select>

            <label style="color:white; font-weight:700; margin-bottom:0.5rem; display:block;">Frage-Typ:</label>
            <select id="customType">
                <option value="text">üìù Text (normale Frage)</option>
                <option value="math">üî¢ Mathe (Rechenaufgabe)</option>
                <option value="error">üîç Fehlersuche</option>
            </select>

            <label style="color:white; font-weight:700; margin-bottom:0.5rem; display:block;">Frage:</label>
            <textarea id="customQuestion" placeholder="z.B. Wie lautet die Hauptstadt von..."></textarea>

            <label style="color:white; font-weight:700; margin-bottom:0.5rem; display:block;">Antwort:</label>
            <input type="text" id="customAnswer" placeholder="z.B. Berlin">

            <label style="color:white; font-weight:700; margin-bottom:0.5rem; display:block;">Punktwert:</label>
            <select id="customPoints">
                <option value="100">100 Punkte (sehr leicht)</option>
                <option value="200">200 Punkte (leicht)</option>
                <option value="300" selected>300 Punkte (mittel)</option>
                <option value="400">400 Punkte (schwer)</option>
                <option value="500">500 Punkte (sehr schwer)</option>
            </select>

            <div style="background:rgba(168,85,247,0.1); padding:1rem; border-radius:0.75rem; margin:1rem 0;">
                <p style="color:#c084fc; font-size:0.9rem;">üí° <strong>Wichtig:</strong> Custom-Kategorie gibt NUR <span id="bonusPointsDisplay">+50</span> Bonus-Punkte (nicht addiert)!</p>
            </div>

            <button class="btn-primary" onclick="addCustomQuestion()">Hinzuf√ºgen</button>
            <button class="btn-secondary" onclick="closeAddCustomQuestionModal()">Abbrechen</button>
        </div>
    </div>
    <!-- Question Modal -->
    <div id="questionModal" class="modal">
        <div class="modal-content">
            <h2 style="background:linear-gradient(135deg,#9333ea,#db2777); padding:1.5rem; border-radius:0.75rem; text-align:center; margin-bottom:1.5rem; font-size:2rem;">
                <span id="questionPoints">100</span> Punkte
                <span id="customBadge" style="display:none; font-size:1rem; color:#fbbf24;"> ‚≠ê CUSTOM</span>
            </h2>
            
            <div id="questionTimerDisplay" class="question-timer" style="display:none;">30</div>
            
            <div style="text-align:center; margin-bottom:1rem;">
                <span id="questionType" class="type-badge type-text">TEXT</span>
            </div>

            <p id="questionText" style="font-size:1.5rem; text-align:center; margin:2rem 0; line-height:1.6;"></p>
            
            <!-- Fehlersuche Hint (NUR F√úR HOST!) -->
            <div id="errorHintDisplay" class="error-hint" style="display:none;">
                <p style="color:#fbbf24; font-weight:700; margin-bottom:0.5rem;">üéôÔ∏è NUR F√úR HOST SICHTBAR:</p>
                <p style="color:#ef4444; font-weight:700; margin-bottom:0.5rem;">‚ùå Fehler hier:</p>
                <p id="errorHintText" style="font-size:1.2rem; font-weight:900;"></p>
            </div>
            
            <div id="hostAnswerDisplay" style="display:none;">
                <div style="background:rgba(168,85,247,0.2); padding:1rem; border-radius:0.75rem; margin:1rem 0; border:2px solid #a855f7;">
                    <p style="color:#fbbf24; font-weight:700; margin-bottom:0.5rem;">üéôÔ∏è NUR F√úR HOST SICHTBAR:</p>
                    <p style="color:#c084fc; font-weight:700; margin-bottom:0.5rem;">Richtige Antwort:</p>
                    <p id="hostCorrectAnswer" style="font-size:1.3rem; font-weight:900;"></p>
                </div>
            </div>

            <div id="initialState" style="display:none;">
                <p style="text-align:center; color:#c084fc; margin-bottom:1rem;">Du bist an der Reihe!</p>
                <input type="text" id="playerAnswerInput" placeholder="Deine Antwort">
                <button class="btn-primary" onclick="submitPlayerAnswer()">Antwort absenden</button>
            </div>

            <div id="buzzerState" style="display:none;">
                <div class="buzzer-warning">
                    <p style="font-size:1.2rem; margin-bottom:0.5rem;">‚ö†Ô∏è Falsche Antwort!</p>
                    <p class="timer"><span id="buzzerTimer">5</span>s</p>
                    <p style="color:#c084fc;">Andere Spieler k√∂nnen jetzt buzzern!</p>
                </div>
                <button class="buzz-btn btn-primary" onclick="buzz()" id="buzzBtn">üîî BUZZ!</button>
            </div>

            <div id="buzzAnswerState" style="display:none;">
                <p style="text-align:center; color:#c084fc; margin-bottom:1rem;">Du hast gebuzzert! Du hast 5 Sekunden:</p>
                <div id="buzzerAnswerTimer" class="question-timer">5</div>
                <input type="text" id="buzzAnswerInput" placeholder="Deine Antwort">
                <button class="btn-primary" onclick="submitBuzzAnswer()">Antwort absenden</button>
            </div>

            <div id="awaitingHost" style="display:none; text-align:center; padding:2rem;">
                <p style="font-size:1.5rem; color:#c084fc; margin-bottom:1rem;">Warte auf Host-Entscheidung...</p>
                <p id="submittedAnswer" style="font-size:1.2rem; font-weight:700;"></p>
            </div>

            <div id="hostDecision" style="display:none;">
                <div style="background:rgba(168,85,247,0.1); padding:1.5rem; border-radius:0.75rem; margin:1rem 0; border:2px solid #a855f7;">
                    <p style="color:white; font-weight:700; margin-bottom:1rem;">Spieler-Antwort:</p>
                    <p id="hostPlayerAnswer" style="font-size:1.5rem; font-weight:900; margin-bottom:1rem;"></p>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem;">
                        <button class="btn-success" onclick="hostDecision(true)">‚úÖ Richtig</button>
                        <button class="btn-danger" onclick="hostDecision(false)">‚ùå Falsch</button>
                    </div>
                </div>
            </div>

            <!-- NEU: Bonus-Section f√ºr Fehlersuche-Complex -->
<div id="bonusState" style="display:none;">
                <div class="bonus-section">
                    <div style="background:rgba(34,197,94,0.2); padding:1rem; border-radius:0.5rem; margin-bottom:1rem; border:2px solid #22c55e;">
                        <p style="color:#22c55e; font-size:1.3rem; font-weight:900;">‚úÖ RICHTIG! +<span id="earnedPoints">400</span> Punkte!</p>
                    </div>
                    <h3 style="color:#fbbf24;">üéØ BONUS-CHANCE!</h3>
                    <p style="color:white; margin:1rem 0; font-size:1.1rem; line-height:1.6;">
                        Du hast "Falsch" richtig erkannt!<br>
                        <strong>Kannst du auch die richtige Antwort nennen?</strong>
                    </p>
                    <p style="color:#fbbf24; font-size:1.2rem; font-weight:700; margin-bottom:1rem;">
                        üìà Bis zu +<span id="maxBonusPoints">150</span> Bonus-Punkte m√∂glich!
                    </p>
                    <p style="color:#94a3b8; font-size:0.9rem; margin-bottom:1rem;">
                        üí° Keine Strafe bei falscher Antwort - nur Gewinn m√∂glich!
                    </p>
                    <input type="text" id="bonusAnswerInput" placeholder="Richtige Antwort (optional)" style="margin-bottom:1rem; width:100%; padding:0.75rem; font-size:1rem;" onkeypress="if(event.key==='Enter') submitBonusAnswer()">
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem;">
                        <button class="btn-warning" onclick="submitBonusAnswer()">üéØ Bonus versuchen</button>
                        <button class="btn-secondary" onclick="skipBonus()">√úberspringen</button>
                    </div>
                </div>
            </div>
                </div>
            </div>

            <!-- NEU: Host bewertet Bonus -->
            <div id="hostBonusDecision" style="display:none;">
                <div class="bonus-section">
                    <h3>üéØ Bonus-Bewertung</h3>
                    <p style="color:white; font-weight:700;">Spieler-Antwort:</p>
                    <p id="hostBonusPlayerAnswer" style="font-size:1.3rem; font-weight:900; color:#fbbf24; margin-bottom:1rem;"></p>
                    <p style="color:#c084fc; font-weight:700;">Richtige Antwort:</p>
                    <p id="hostBonusCorrectAnswer" style="font-size:1.2rem; margin-bottom:1rem;"></p>
                    
                    <label style="color:white; font-weight:700; display:block; margin-bottom:0.5rem;">Bonus-Punkte vergeben:</label>
                    <input type="number" id="bonusPointsInput" value="0" min="0" step="10" style="width:150px; margin-bottom:1rem;">
                    <p style="color:#64748b; font-size:0.85rem; margin-bottom:1rem;">Max: <span id="hostMaxBonus">150</span> Punkte</p>
                    
                    <button class="btn-warning" onclick="awardBonus()">Bonus vergeben</button>
                    <button class="btn-secondary" onclick="skipBonusHost()">Kein Bonus</button>
                </div>
            </div>

            <div id="resultState" style="display:none; text-align:center; padding:2rem;">
                <p id="resultText" style="font-size:2rem; font-weight:700; margin-bottom:1rem;"></p>
                <p id="correctAnswerText" style="font-size:1.2rem; color:#c084fc;"></p>
            </div>
        </div>
    </div>

    <!-- Final Scores Modal -->
    <div id="finalScoresModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <h1 style="text-align:center; font-size:4rem; margin-bottom:2rem;">üèÜ Spiel beendet!</h1>
            <div id="finalScoresList"></div>
            <button class="btn-primary" onclick="location.reload()" style="margin-top:2rem;">Neues Spiel</button>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
    <script>
        // Sound System
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const audioCtx = new AudioContext();
        let soundEnabled = true;

        const sounds = {
            buzz: () => {
                if (!soundEnabled) return;
                const oscillator = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);
                
                oscillator.frequency.value = 800;
                oscillator.type = 'square';
                gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.2);
                
                oscillator.start(audioCtx.currentTime);
                oscillator.stop(audioCtx.currentTime + 0.2);
            },
            
            correct: () => {
                if (!soundEnabled) return;
                const oscillator = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);
                
                oscillator.frequency.setValueAtTime(523, audioCtx.currentTime);
                oscillator.frequency.setValueAtTime(659, audioCtx.currentTime + 0.1);
                oscillator.frequency.setValueAtTime(784, audioCtx.currentTime + 0.2);
                oscillator.type = 'sine';
                gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
                
                oscillator.start(audioCtx.currentTime);
                oscillator.stop(audioCtx.currentTime + 0.3);
            },
            
            wrong: () => {
                if (!soundEnabled) return;
                const oscillator = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);
                
                oscillator.frequency.setValueAtTime(400, audioCtx.currentTime);
                oscillator.frequency.setValueAtTime(200, audioCtx.currentTime + 0.2);
                oscillator.type = 'sawtooth';
                gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.4);
                
                oscillator.start(audioCtx.currentTime);
                oscillator.stop(audioCtx.currentTime + 0.4);
            },
            
            tick: () => {
                if (!soundEnabled) return;
                const oscillator = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);
                
                oscillator.frequency.value = 1000;
                oscillator.type = 'sine';
                gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.05);
                
                oscillator.start(audioCtx.currentTime);
                oscillator.stop(audioCtx.currentTime + 0.05);
            },
            
            gameEnd: () => {
                if (!soundEnabled) return;
                const notes = [523, 659, 784, 1047];
                notes.forEach((freq, i) => {
                    const oscillator = audioCtx.createOscillator();
                    const gainNode = audioCtx.createGain();
                    oscillator.connect(gainNode);
                    gainNode.connect(audioCtx.destination);
                    
                    const startTime = audioCtx.currentTime + (i * 0.15);
                    oscillator.frequency.value = freq;
                    oscillator.type = 'sine';
                    gainNode.gain.setValueAtTime(0.2, startTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, startTime + 0.3);
                    
                    oscillator.start(startTime);
                    oscillator.stop(startTime + 0.3);
                });
            }
        };

        function toggleSound() {
            soundEnabled = !soundEnabled;
            const btn = document.getElementById('soundToggle');
            if (btn) {
                btn.textContent = soundEnabled ? 'üîä' : 'üîá';
            }
        }

        function showFinalScores(finalScores) {
            sounds.gameEnd();
            
            const list = document.getElementById('finalScoresList');
            list.innerHTML = '';
            
            finalScores.forEach((item, index) => {
                const div = document.createElement('div');
                div.style.cssText = `
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    padding: 1.5rem;
                    margin: 1rem 0;
                    background: ${index === 0 ? 'linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%)' : 'rgba(15, 23, 42, 0.5)'};
                    border-radius: 0.75rem;
                    border-left: 4px solid ${index === 0 ? '#fbbf24' : '#9333ea'};
                    font-size: 1.5rem;
                    font-weight: 700;
                `;
                
                const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : `${index + 1}.`;
                
                div.innerHTML = `
                    <span style="display:flex; gap:1rem; align-items:center;">
                        <span style="font-size:2rem;">${medal}</span>
                        <span>${item.name}</span>
                    </span>
                    <span style="font-size:2rem; color:#c084fc;">${item.score}</span>
                `;
                list.appendChild(div);
            });
            
            document.getElementById('finalScoresModal').classList.add('active');
        }

        let socket;
        let gameData = {
            roomCode: null,
            playerId: null,
            isHost: false,
            players: [],
            settings: {},
            customQuestions: [],
            currentPlayer: null,
            currentTeam: null,
            teams: [],
            board: {},
            scores: {},
            buzzedPlayers: []
        };
        let buzzerTimerInterval = null;
        let questionTimerInterval = null;

        function initSocket() {
            socket = io({ transports: ['polling', 'websocket'], upgrade: true });

            socket.on('connect', () => {
                console.log('Connected:', socket.id);
            });

            socket.on('game-created', (data) => {
                gameData.roomCode = data.roomCode;
                gameData.playerId = data.hostId;
                gameData.isHost = true;
                showScreen('lobbyScreen');
                document.getElementById('roomCode').textContent = data.roomCode;
                document.getElementById('hostSettings').style.display = 'block';
                document.getElementById('startBtn').style.display = 'block';
                updateBonusPointsDisplay();
            });

            socket.on('joined-game', (data) => {
                gameData.roomCode = data.roomCode;
                gameData.playerId = data.playerId;
                gameData.isHost = false;
                showScreen('lobbyScreen');
                document.getElementById('roomCode').textContent = data.roomCode;
            });

            socket.on('player-list-update', (data) => {
                gameData.players = data.players;
                gameData.settings = data.settings;
                gameData.customQuestions = data.customQuestions || [];
                updatePlayerList(data.players);
                updateCustomQuestionsList();
            });

            socket.on('settings-updated', (settings) => {
                gameData.settings = settings;
                if (gameData.isHost) {
                    updateBonusPointsDisplay();
                }
            });

            socket.on('custom-questions-updated', (questions) => {
                gameData.customQuestions = questions;
                updateCustomQuestionsList();
            });

            socket.on('game-started', (data) => {
                gameData.board = data.board;
                gameData.currentPlayer = data.currentPlayer;
                gameData.currentTeam = data.currentTeam;
                gameData.teams = data.teams;
                gameData.scores = data.scores;
                gameData.settings = data.settings;
                
                showScreen('gameScreen');
                
                if (gameData.isHost) {
                    document.getElementById('hostBadge').style.display = 'block';
                }
                
                if (gameData.settings.teamMode) {
                    setupTeamSidebars();
                    document.getElementById('singleScoreboard').style.display = 'none';
                } else {
                    document.getElementById('singleScoreboard').style.display = 'block';
                    updateScoreboard();
                }
                
                renderBoard();
                updateCurrentTurn();
            });

            socket.on('question-selected', (data) => {
                gameData.buzzedPlayers = [];
                
                showQuestionModal(data);
                
                if (gameData.isHost) {
                    document.getElementById('hostAnswerDisplay').style.display = 'block';
                    document.getElementById('hostCorrectAnswer').textContent = data.correctAnswer;
                    
                    // Fehlersuche Hint NUR f√ºr Host anzeigen!
                    if (data.errorType === 'obvious' && data.errorHint) {
                        document.getElementById('errorHintDisplay').style.display = 'block';
                        document.getElementById('errorHintText').textContent = data.errorHint;
                    }
                }
                
                if (data.phase === 'initial') {
                    startQuestionTimer(data.timeLimit);
                    
                    if (!gameData.isHost && data.answeringPlayer && data.answeringPlayer.id === gameData.playerId) {
                        document.getElementById('initialState').style.display = 'block';
                        gameData.buzzedPlayers.push(gameData.playerId);
                    }
                }
            });

            socket.on('answer-submitted', (data) => {
                stopQuestionTimer();
                
                if (gameData.isHost) {
                    document.getElementById('hostDecision').style.display = 'block';
                    document.getElementById('hostPlayerAnswer').textContent = `${data.playerName}: "${data.answer}"`;
                }
            });

            socket.on('awaiting-host-decision', (data) => {
                stopQuestionTimer();
                
                if (!gameData.isHost) {
                    hideAllQuestionStates();
                    document.getElementById('awaitingHost').style.display = 'block';
                    document.getElementById('submittedAnswer').textContent = `${data.playerName} hat geantwortet...`;
                }
            });

            // NEU: Bonus-Antwort eingereicht
            socket.on('bonus-answer-submitted', (data) => {
                if (gameData.isHost) {
                    hideAllQuestionStates();
                    document.getElementById('hostBonusDecision').style.display = 'block';
                    document.getElementById('hostBonusPlayerAnswer').textContent = data.bonusAnswer;
                    document.getElementById('hostBonusCorrectAnswer').textContent = data.correctAnswer;
                    document.getElementById('bonusPointsInput').value = data.bonusPoints;
                    document.getElementById('hostMaxBonus').textContent = data.bonusPoints;
                    document.getElementById('bonusPointsInput').max = data.bonusPoints;
                }
            });

            // NEU: Bonus wurde vergeben
            socket.on('bonus-awarded', (data) => {
                gameData.scores = data.scores;
                updateScores();
                
                hideAllQuestionStates();
                document.getElementById('resultState').style.display = 'block';
                document.getElementById('resultText').textContent = `üéØ +${data.bonusPoints} BONUS!`;
                document.getElementById('resultText').style.color = '#fbbf24';
                document.getElementById('correctAnswerText').textContent = `${data.playerName} hat Bonus-Punkte bekommen!`;
                
                setTimeout(() => {
                    closeQuestionModal();
                    renderBoard();
                    updateCurrentTurn();
                }, 3000);
            });
            socket.on('answer-result', (data) => {
                gameData.scores = data.scores;
                
                if (data.board) {
                    gameData.board = data.board;
                }
                
                updateScores();
                
                hideAllQuestionStates();
                stopQuestionTimer();
                
                if (data.correct) {
                    sounds.correct();
                    
                    // Bei Fehlersuche-Complex: Bonus-Frage!
                    if (data.awaitBonus) {
                        if (data.playerId === gameData.playerId || (gameData.settings.teamMode && gameData.getPlayerTeam && gameData.getPlayerTeam(data.playerId))) {
                            document.getElementById('bonusState').style.display = 'block';
                            document.getElementById('earnedPoints').textContent = data.points;
                            document.getElementById('maxBonusPoints').textContent = data.maxBonusPoints;
                            
                            // Input leeren und fokussieren
                            const bonusInput = document.getElementById('bonusAnswerInput');
                            bonusInput.value = '';
                            setTimeout(() => bonusInput.focus(), 100);
                        } else {
                            document.getElementById('awaitingHost').style.display = 'block';
                            document.getElementById('submittedAnswer').textContent = `${data.playerName} kann Bonus-Antwort geben...`;
                        }
                        return;
                    }
                    
                    document.getElementById('resultState').style.display = 'block';
                    
                    if (data.autoCorrect) {
                        document.getElementById('resultText').textContent = `‚úÖ Auto-Correct! +${data.points} Punkte`;
                    } else {
                        document.getElementById('resultText').textContent = `‚úÖ Richtig! +${data.points} Punkte`;
                    }
                    
                    document.getElementById('resultText').style.color = '#10b981';
                    document.getElementById('correctAnswerText').textContent = '';
                    
                    gameData.buzzedPlayers = [];
                    
                    setTimeout(() => {
                        closeQuestionModal();
                        renderBoard();
                    }, 3000);
                } else {
                    sounds.wrong();
                    
                    if (data.phase === 'buzzer') {
                        if (!gameData.isHost) {
                            document.getElementById('buzzerState').style.display = 'block';
                            
                            const buzzBtn = document.getElementById('buzzBtn');
                            if (gameData.buzzedPlayers.includes(gameData.playerId)) {
                                buzzBtn.disabled = true;
                                buzzBtn.textContent = '‚ùå Du hast bereits geantwortet';
                            } else {
                                buzzBtn.disabled = false;
                                buzzBtn.textContent = 'üîî BUZZ!';
                            }
                            
                            startBuzzerTimer(data.buzzerTime);
                        }
                    } else if (data.phase === 'team-opportunity') {
                        document.getElementById('resultState').style.display = 'block';
                        document.getElementById('resultText').textContent = `‚ùå Falsch! ${data.points} Punkte`;
                        document.getElementById('resultText').style.color = '#f97316';
                        document.getElementById('correctAnswerText').textContent = `Gegnerteam ${data.nextTeam.name} ist jetzt dran!`;
                        
                        setTimeout(() => {
                            closeQuestionModal();
                            renderBoard();
                        }, 3000);
                    }
                }
            });

            socket.on('player-buzzed', (data) => {
                hideAllQuestionStates();
                stopBuzzerTimer();
                
                if (data.playerId === gameData.playerId) {
                    document.getElementById('buzzAnswerState').style.display = 'block';
                    startBuzzerAnswerTimer(5);
                } else {
                    document.getElementById('awaitingHost').style.display = 'block';
                    document.getElementById('submittedAnswer').textContent = `${data.playerName} antwortet...`;
                }
            });

            socket.on('buzzer-timeout', (data) => {
                hideAllQuestionStates();
                stopBuzzerTimer();
                stopQuestionTimer();
                
                document.getElementById('resultState').style.display = 'block';
                document.getElementById('resultText').textContent = '‚è±Ô∏è Zeit abgelaufen!';
                document.getElementById('resultText').style.color = '#f97316';
                document.getElementById('correctAnswerText').textContent = `Richtige Antwort: ${data.correctAnswer}`;
                
                gameData.currentPlayer = data.nextPlayer;
                gameData.currentTeam = data.nextTeam;
                
                gameData.buzzedPlayers = [];
                
                if (data.board) {
                    gameData.board = data.board;
                }
                
                setTimeout(() => {
                    closeQuestionModal();
                    renderBoard();
                    updateCurrentTurn();
                }, 3000);
            });

            socket.on('question-closed', (data) => {
                if (data.nextPlayer) gameData.currentPlayer = data.nextPlayer;
                if (data.nextTeam) gameData.currentTeam = data.nextTeam;
                
                closeQuestionModal();
                renderBoard();
                updateCurrentTurn();
            });

            socket.on('game-ended', (data) => {
                closeQuestionModal();
                showFinalScores(data.finalScores);
            });

            socket.on('host-disconnected', () => {
                alert('Host hat das Spiel verlassen. Spiel wird beendet.');
                location.reload();
            });

            socket.on('error', (msg) => {
                alert(msg);
            });
        }

        // Timer Functions
        function startQuestionTimer(seconds) {
            const display = document.getElementById('questionTimerDisplay');
            display.style.display = 'block';
            display.textContent = seconds;
            display.className = 'question-timer';
            
            let timeLeft = seconds;
            
            questionTimerInterval = setInterval(() => {
                timeLeft--;
                display.textContent = timeLeft;
                
                if (timeLeft <= 5) {
                    display.className = 'question-timer danger';
                    sounds.tick();
                } else if (timeLeft <= 10) {
                    display.className = 'question-timer warning';
                }
                
                if (timeLeft <= 0) {
                    stopQuestionTimer();
                }
            }, 1000);
        }

        function stopQuestionTimer() {
            if (questionTimerInterval) {
                clearInterval(questionTimerInterval);
                questionTimerInterval = null;
            }
            document.getElementById('questionTimerDisplay').style.display = 'none';
        }

        function startBuzzerAnswerTimer(seconds) {
            const display = document.getElementById('buzzerAnswerTimer');
            let timeLeft = seconds;
            display.textContent = timeLeft;
            display.className = 'question-timer danger';
            
            questionTimerInterval = setInterval(() => {
                timeLeft--;
                display.textContent = timeLeft;
                sounds.tick();
                
                if (timeLeft <= 0) {
                    clearInterval(questionTimerInterval);
                }
            }, 1000);
        }

        function startBuzzerTimer(seconds) {
            let timeLeft = seconds;
            document.getElementById('buzzerTimer').textContent = timeLeft;
            
            sounds.tick();
            
            buzzerTimerInterval = setInterval(() => {
                timeLeft--;
                document.getElementById('buzzerTimer').textContent = timeLeft;
                
                sounds.tick();
                
                if (timeLeft <= 0) {
                    stopBuzzerTimer();
                }
            }, 1000);
        }

        function stopBuzzerTimer() {
            if (buzzerTimerInterval) {
                clearInterval(buzzerTimerInterval);
                buzzerTimerInterval = null;
            }
        }

        // Helper Functions
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }

        function createGame() {
            const name = document.getElementById('playerNameInput').value.trim();
            if (!name) return alert('Bitte gib einen Namen ein!');
            socket.emit('create-game', name);
        }

        function showJoinModal() {
            document.getElementById('joinModal').classList.add('active');
        }

        function closeJoinModal() {
            document.getElementById('joinModal').classList.remove('active');
        }

        function joinGame() {
            const code = document.getElementById('joinRoomCode').value.trim().toUpperCase();
            const name = document.getElementById('joinPlayerName').value.trim();
            if (!code || !name) return alert('Bitte f√ºlle alle Felder aus!');
            socket.emit('join-game', { roomCode: code, playerName: name });
            closeJoinModal();
        }

        function toggleTeamMode() {
            const enabled = document.getElementById('teamModeToggle').checked;
            document.getElementById('teamSettings').style.display = enabled ? 'block' : 'none';
            updateSettings();
        }

        function updateSettings() {
            const settings = {
                teamMode: document.getElementById('teamModeToggle').checked,
                numberOfTeams: parseInt(document.getElementById('numberOfTeams').value),
                questionTime: parseInt(document.getElementById('questionTime').value),
                customQuestionsLimit: parseInt(document.getElementById('customQuestionsLimit').value),
                customBonusPoints: parseInt(document.getElementById('customBonusPoints').value)
            };
            socket.emit('update-settings', { roomCode: gameData.roomCode, settings });
            updateBonusPointsDisplay();
        }

        function updateBonusPointsDisplay() {
            const bonus = parseInt(document.getElementById('customBonusPoints').value);
            document.getElementById('bonusPointsDisplay').textContent = `+${bonus}`;
        }

        function showAddCustomQuestionModal() {
            const limit = parseInt(document.getElementById('customQuestionsLimit').value);
            if (gameData.customQuestions.length >= limit) {
                return alert(`Maximum ${limit} Custom-Fragen erreicht!`);
            }
            document.getElementById('addCustomQuestionModal').classList.add('active');
        }

        function closeAddCustomQuestionModal() {
            document.getElementById('addCustomQuestionModal').classList.remove('active');
            document.getElementById('customCategory').value = 'allgemeinwissen';
            document.getElementById('customType').value = 'text';
            document.getElementById('customQuestion').value = '';
            document.getElementById('customAnswer').value = '';
            document.getElementById('customPoints').value = '300';
        }

        function addCustomQuestion() {
            const question = {
                category: document.getElementById('customCategory').value,
                type: document.getElementById('customType').value,
                q: document.getElementById('customQuestion').value.trim(),
                a: document.getElementById('customAnswer').value.trim(),
                points: parseInt(document.getElementById('customPoints').value)
            };
            
            if (!question.q || !question.a) {
                return alert('Bitte f√ºlle alle Felder aus!');
            }
            
            socket.emit('add-custom-question', { roomCode: gameData.roomCode, question });
            closeAddCustomQuestionModal();
        }

        function removeCustomQuestion(questionId) {
            if (confirm('Custom Frage wirklich l√∂schen?')) {
                socket.emit('remove-custom-question', { roomCode: gameData.roomCode, questionId });
            }
        }

        function updateCustomQuestionsList() {
            const list = document.getElementById('customQuestionsList');
            const count = document.getElementById('customQuestionsCount');
            const max = document.getElementById('customQuestionsMax');
            
            count.textContent = gameData.customQuestions.length;
            max.textContent = gameData.settings.customQuestionsLimit || 5;
            
            list.innerHTML = '';
            
            gameData.customQuestions.forEach(q => {
                const div = document.createElement('div');
                div.className = 'custom-question-item';
                
                const typeNames = { text: 'üìù Text', math: 'üî¢ Mathe', error: 'üîç Fehler' };
                const catNames = {
                    allgemeinwissen: 'Allgemeinwissen',
                    wissenschaft: 'Wissenschaft',
                    geschichte: 'Geschichte',
                    sport: 'Sport',
                    geographie: 'Geographie',
                    mathe: 'Mathe',
                    fehlersuche: 'Fehlersuche',
                    custom: '‚ú® Custom'
                };
                
                div.innerHTML = `
                    <div class="custom-question-info">
                        <div style="font-weight:700;">${q.q.substring(0, 60)}${q.q.length > 60 ? '...' : ''}</div>
                        <div class="custom-question-meta">
                            <span>${catNames[q.category]}</span>
                            <span>${typeNames[q.type]}</span>
                            <span>${q.points}P</span>
                            ${q.category === 'custom' ? '<span style="color:#fbbf24;">‚≠ê NUR Bonus!</span>' : ''}
                        </div>
                    </div>
                    <button class="btn-danger btn-small" onclick="removeCustomQuestion('${q.id}')">üóëÔ∏è</button>
                `;
                list.appendChild(div);
            });
        }

        function startGame() {
            if (gameData.players.length < 2) {
                return alert('Mindestens 2 Spieler erforderlich!');
            }
            socket.emit('start-game', gameData.roomCode);
        }

        function updatePlayerList(players) {
            const list = document.getElementById('playerList');
            list.innerHTML = '';
            document.getElementById('playerCount').textContent = players.length;
            
            players.forEach(player => {
                const div = document.createElement('div');
                div.className = 'player-item';
                div.innerHTML = `
                    <div style="width:12px; height:12px; border-radius:50%; background:#10b981;"></div>
                    <span style="font-weight:600;">${player.name}</span>
                `;
                list.appendChild(div);
            });
        }
        function setupTeamSidebars() {
            const container = document.getElementById('teamSidebars');
            container.innerHTML = '';
            document.getElementById('gameContent').classList.add('with-teams');
            
            gameData.teams.forEach((team, index) => {
                const sidebar = document.createElement('div');
                sidebar.className = `team-sidebar ${index === 0 ? 'left' : 'right'}`;
                sidebar.innerHTML = `
                    <div class="team-header">${team.name}</div>
                    <div class="team-score">${gameData.scores[team.id] || 0}</div>
                    <div class="team-players">
                        ${team.players.map(p => `<div class="team-player">${p.name}</div>`).join('')}
                    </div>
                `;
                container.appendChild(sidebar);
            });
        }

        function updateScores() {
            if (gameData.settings.teamMode) {
                document.querySelectorAll('.team-sidebar').forEach((sidebar, index) => {
                    const team = gameData.teams[index];
                    sidebar.querySelector('.team-score').textContent = gameData.scores[team.id] || 0;
                });
            } else {
                updateScoreboard();
            }
        }

        function updateScoreboard() {
            const list = document.getElementById('scoresList');
            list.innerHTML = '';
            
            const sorted = Object.entries(gameData.scores)
                .map(([id, score]) => ({
                    player: gameData.players.find(p => p.id === id),
                    score
                }))
                .sort((a, b) => b.score - a.score);
            
            sorted.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'score-item' + (index === 0 ? ' leader' : '');
                div.innerHTML = `
                    <span style="font-weight:600;">${item.player.name}</span>
                    <span style="font-size:1.3rem; font-weight:700;">${item.score}</span>
                `;
                list.appendChild(div);
            });
        }

        function renderBoard() {
            const board = document.getElementById('gameBoard');
            board.innerHTML = '';
            
            const categories = Object.keys(gameData.board);
            const catNames = {
                allgemeinwissen: 'Allgemeinwissen',
                wissenschaft: 'Wissenschaft',
                geschichte: 'Geschichte',
                sport: 'Sport',
                geographie: 'Geographie',
                mathe: 'üî¢ Mathe',
                fehlersuche: 'üîç Fehlersuche',
                custom: '‚ú® Custom'
            };
            
            categories.forEach((category) => {
                const column = document.createElement('div');
                column.style.display = 'flex';
                column.style.flexDirection = 'column';
                column.style.gap = '1rem';
                
                const header = document.createElement('div');
                header.className = 'category-header' + (category === 'custom' ? ' custom-cat' : '');
                header.textContent = catNames[category] || category;
                column.appendChild(header);
                
                gameData.board[category].forEach((q, qIndex) => {
                    const cell = document.createElement('div');
                    cell.className = 'question-cell' + (q.completed ? ' completed' : '') + (q.isCustom ? ' custom-q' : '');
                    cell.textContent = q.points;
                    
                    if (!q.completed && !gameData.isHost) {
                        if (gameData.settings.teamMode) {
                            const playerTeam = gameData.teams.find(t => t.players.some(p => p.id === gameData.playerId));
                            if (playerTeam && playerTeam.id === gameData.currentTeam.id) {
                                cell.onclick = () => selectQuestion(category, qIndex);
                            }
                        } else {
                            if (gameData.currentPlayer.id === gameData.playerId) {
                                cell.onclick = () => selectQuestion(category, qIndex);
                            }
                        }
                    }
                    
                    column.appendChild(cell);
                });
                
                board.appendChild(column);
            });
        }

        function selectQuestion(category, index) {
            socket.emit('select-question', { roomCode: gameData.roomCode, category, index });
        }

        function updateCurrentTurn() {
            const display = document.getElementById('currentTurnDisplay');
            if (gameData.settings.teamMode) {
                display.textContent = `Am Zug: ${gameData.currentTeam.name}`;
            } else {
                display.textContent = `Am Zug: ${gameData.currentPlayer.name}`;
            }
        }

        function showQuestionModal(data) {
            document.getElementById('questionText').textContent = data.question;
            document.getElementById('questionPoints').textContent = data.points;
            
            if (data.category === 'custom') {
                document.getElementById('customBadge').style.display = 'inline';
            } else {
                document.getElementById('customBadge').style.display = 'none';
            }
            
            const typeNames = { text: 'TEXT', math: 'MATHE', error: 'FEHLERSUCHE' };
            const typeClasses = { text: 'type-text', math: 'type-math', error: 'type-error' };
            const typeBadge = document.getElementById('questionType');
            typeBadge.textContent = typeNames[data.type] || 'TEXT';
            typeBadge.className = 'type-badge ' + (typeClasses[data.type] || 'type-text');
            
            hideAllQuestionStates();
            document.getElementById('questionModal').classList.add('active');
        }

        function hideAllQuestionStates() {
            document.getElementById('initialState').style.display = 'none';
            document.getElementById('buzzerState').style.display = 'none';
            document.getElementById('buzzAnswerState').style.display = 'none';
            document.getElementById('awaitingHost').style.display = 'none';
            document.getElementById('hostDecision').style.display = 'none';
            document.getElementById('resultState').style.display = 'none';
            document.getElementById('bonusState').style.display = 'none';
            document.getElementById('hostBonusDecision').style.display = 'none';
            document.getElementById('errorHintDisplay').style.display = 'none';
        }

        function closeQuestionModal() {
            document.getElementById('questionModal').classList.remove('active');
            document.getElementById('playerAnswerInput').value = '';
            document.getElementById('buzzAnswerInput').value = '';
            document.getElementById('bonusAnswerInput').value = '';
            hideAllQuestionStates();
            stopBuzzerTimer();
            stopQuestionTimer();
        }

        function submitPlayerAnswer() {
            const answer = document.getElementById('playerAnswerInput').value.trim();
            if (!answer) return;
            socket.emit('submit-answer', { roomCode: gameData.roomCode, answer });
        }

        function submitBuzzAnswer() {
            const answer = document.getElementById('buzzAnswerInput').value.trim();
            if (!answer) return;
            socket.emit('submit-answer', { roomCode: gameData.roomCode, answer });
        }

        // NEU: Bonus-Antwort absenden
        function submitBonusAnswer() {
            const bonusAnswer = document.getElementById('bonusAnswerInput').value.trim();
            if (!bonusAnswer) {
                // Spieler √ºberspringt Bonus
                skipBonus();
                return;
            }
            socket.emit('submit-bonus-answer', { roomCode: gameData.roomCode, bonusAnswer });
            
            hideAllQuestionStates();
            document.getElementById('awaitingHost').style.display = 'block';
            document.getElementById('submittedAnswer').textContent = 'Host bewertet Bonus-Antwort...';
        }

        // NEU: Bonus √ºberspringen
        function skipBonus() {
            socket.emit('skip-bonus', { roomCode: gameData.roomCode });
            
            hideAllQuestionStates();
            document.getElementById('resultState').style.display = 'block';
            document.getElementById('resultText').textContent = 'Bonus √ºbersprungen';
            document.getElementById('resultText').style.color = '#64748b';
            
            setTimeout(() => {
                closeQuestionModal();
                renderBoard();
                updateCurrentTurn();
            }, 2000);
        }

        // NEU: Host vergibt Bonus
        function awardBonus() {
            const bonusPoints = parseInt(document.getElementById('bonusPointsInput').value) || 0;
            if (bonusPoints > 0) {
                socket.emit('award-bonus', { roomCode: gameData.roomCode, bonusPoints });
            } else {
                skipBonusHost();
            }
        }

        // NEU: Host vergibt keinen Bonus
        function skipBonusHost() {
            hideAllQuestionStates();
            document.getElementById('resultState').style.display = 'block';
            document.getElementById('resultText').textContent = 'Kein Bonus vergeben';
            document.getElementById('resultText').style.color = '#64748b';
            
            setTimeout(() => {
                closeQuestionModal();
                renderBoard();
                updateCurrentTurn();
            }, 2000);
        }

        function buzz() {
            sounds.buzz();
            
            if (!gameData.buzzedPlayers.includes(gameData.playerId)) {
                gameData.buzzedPlayers.push(gameData.playerId);
            }
            socket.emit('buzz', { roomCode: gameData.roomCode });
        }

        function hostDecision(isCorrect) {
            socket.emit('host-decision', { roomCode: gameData.roomCode, isCorrect });
            document.getElementById('hostDecision').style.display = 'none';
        }

        initSocket();
    </script>
</body>
</html>
